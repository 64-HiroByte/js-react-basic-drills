# Immutability å®Ÿè·µãƒ‰ãƒªãƒ«ï¼ˆäº‹æ•…ä¾‹ãƒ™ãƒ¼ã‚¹ï¼‰

å¯¾è±¡ï¼šReact / Next.js çµŒé¨“è€…
ç›®çš„ï¼šç ´å£Šçš„å¤‰æ›´ã«ã‚ˆã‚‹ãƒã‚°ã‚’å³åº§ã«è¦‹æŠœãã€å®‰å…¨ãªæ›´æ–°ã‚’æ›¸ã‘ã‚‹ã‚ˆã†ã«ã™ã‚‹

---

## ã“ã®ãƒ‰ãƒªãƒ«ã®ç‹™ã„

- ã€Œå‹•ã„ã¦ã„ã‚‹ã‚ˆã†ã«è¦‹ãˆã‚‹ã‘ã©å±é™ºã€ãªã‚³ãƒ¼ãƒ‰ã‚’è¦‹æŠœã
- React state æ›´æ–°ã§ **ãªãœ immutability ãŒå¿…è¦ã‹** ã‚’èª¬æ˜ã§ãã‚‹
- map / reduce / spread ã‚’æ­£ã—ãä½¿ã„åˆ†ã‘ã‚‹

---

# ğŸ”¹ Step 1ï¼šé…åˆ—ã®ç ´å£Šçš„å¤‰æ›´

## å•é¡Œ 1ï¼špush ã®ç½ 

```js
const items = [1, 2, 3];

const addItem = (list, item) => {
  list.push(item);
  return list;
};

const newItems = addItem(items, 4);
console.log(items);    // ???
console.log(newItems); // ???
```

ç¾åœ¨ã®å‡ºåŠ›ï¼š

```
items    â†’ [1, 2, 3, 4] â† å…ƒã®é…åˆ—ã‚‚å¤‰ã‚ã£ã¦ã—ã¾ã†
newItems â†’ [1, 2, 3, 4]
items === newItems â†’ true
```

è³ªå•ï¼šå…ƒã®é…åˆ—ã‚’å¤‰æ›´ã›ãšã€ä»¥ä¸‹ã®å‡ºåŠ›ã«ãªã‚‹ã‚ˆã†ã«ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚

```
items    â†’ [1, 2, 3]ï¼ˆå…ƒã®ã¾ã¾ï¼‰
newItems â†’ [1, 2, 3, 4]ï¼ˆè¿½åŠ å¾Œï¼‰
items === newItems â†’ falseï¼ˆåˆ¥ã®å‚ç…§ï¼‰
```

<details>
<summary>æ¨¡ç¯„è§£ç­”</summary>

```js
const items = [1, 2, 3];

const addItem = (list, item) => {
  return [...list, item]; // æ–°ã—ã„é…åˆ—ã‚’ä½œã‚‹
};

const newItems = addItem(items, 4);
console.log(items);    // [1, 2, 3] â† å…ƒã®é…åˆ—ã¯å¤‰ã‚ã‚‰ãªã„
console.log(newItems); // [1, 2, 3, 4]
```

### è§£èª¬ï¼š

- `push` ã¯**å…ƒã®é…åˆ—ã‚’ç›´æ¥å¤‰æ›´**ã™ã‚‹ï¼ˆç ´å£Šçš„ãƒ¡ã‚½ãƒƒãƒ‰ï¼‰
- ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰æ§‹æ–‡ `[...list, item]` ã§**æ–°ã—ã„é…åˆ—**ã‚’ä½œã‚‹

### ç‰¹ã« React ã«ãŠã„ã¦ã¯ï¼š

React ã¯ state ã®**å‚ç…§ãŒå¤‰ã‚ã£ãŸã‹ã©ã†ã‹**ã§å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’åˆ¤æ–­ã™ã‚‹ã€‚
ç ´å£Šçš„å¤‰æ›´ã ã¨å‚ç…§ãŒåŒã˜ã¾ã¾ãªã®ã§ã€å¤‰åŒ–ãŒæ¤œçŸ¥ã•ã‚Œãªã„ã€‚

### ç ´å£Šçš„ãƒ¡ã‚½ãƒƒãƒ‰ä¸€è¦§ï¼š

| ç ´å£Šçš„ï¼ˆâŒï¼‰ | éç ´å£Šçš„ï¼ˆâœ…ï¼‰ |
|------------|--------------|
| push | [...arr, item] |
| pop | arr.slice(0, -1) |
| splice | arr.filter(...) |
| sort | [...arr].sort() |
| reverse | [...arr].reverse() |

</details>

---

# ğŸ”¹ Step 2ï¼šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ç ´å£Šçš„å¤‰æ›´

## å•é¡Œ 2ï¼šç›´æ¥ä»£å…¥

```js
const user = { id: 1, name: "Taro", age: 20 };

const updateAge = (u) => {
  u.age = 21;
  return u;
};

const newUser = updateAge(user);
console.log(user.age);         // 21 â† å…ƒã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚‚å¤‰ã‚ã£ã¦ã—ã¾ã†
console.log(user === newUser); // true â† åŒã˜å‚ç…§
```

è³ªå•ï¼šå…ƒã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å¤‰æ›´ã›ãšã€ä»¥ä¸‹ã®å‡ºåŠ›ã«ãªã‚‹ã‚ˆã†ã«ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚

```
user.age         â†’ 20ï¼ˆå…ƒã®ã¾ã¾ï¼‰
newUser.age      â†’ 21ï¼ˆæ›´æ–°å¾Œï¼‰
user === newUser â†’ falseï¼ˆåˆ¥ã®å‚ç…§ï¼‰
```

<details>
<summary>æ¨¡ç¯„è§£ç­”</summary>

```js
const user = { id: 1, name: "Taro", age: 20 };

const updateAge = (u) => ({
  ...u,
  age: 21,
});

const newUser = updateAge(user);
console.log(user.age);         // 20 â† å…ƒã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯å¤‰ã‚ã‚‰ãªã„
console.log(user === newUser); // false â† åˆ¥ã®å‚ç…§
```

### è§£èª¬ï¼š

- ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰æ§‹æ–‡ `...u` ã§å…ƒã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ã‚³ãƒ”ãƒ¼
- `age: 21` ã§ä¸Šæ›¸ã
- **æ–°ã—ã„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ**ãŒè¿”ã•ã‚Œã‚‹ãŸã‚ã€å…ƒã® `user` ã¯å¤‰ã‚ã‚‰ãªã„

</details>

---

# ğŸ”¹ Step 3ï¼šmap ã§ã‚‚å£Šã‚Œã‚‹ä¾‹

## å•é¡Œ 3ï¼šmap = å®‰å…¨ã€ã§ã¯ãªã„

```js
const users = [
  { id: 1, name: "Taro", active: false },
  { id: 2, name: "Jiro", active: false },
];

const updated = users.map((user) => {
  user.active = true;
  return user;
});

console.log(users[0].active); // true â† å…ƒã®é…åˆ—å†…ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚‚å¤‰ã‚ã£ã¦ã—ã¾ã†
```

è³ªå•ï¼šå…ƒã®é…åˆ—å†…ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å¤‰æ›´ã›ãšã€ä»¥ä¸‹ã®å‡ºåŠ›ã«ãªã‚‹ã‚ˆã†ã«ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚

```
users[0].active   â†’ falseï¼ˆå…ƒã®ã¾ã¾ï¼‰
updated[0].active â†’ trueï¼ˆæ›´æ–°å¾Œï¼‰
```

<details>
<summary>æ¨¡ç¯„è§£ç­”</summary>

```js
const users = [
  { id: 1, name: "Taro", active: false },
  { id: 2, name: "Jiro", active: false },
];

const updated = users.map((user) => ({
  ...user,
  active: true,
}));

console.log(users[0].active);   // false â† å…ƒã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯å¤‰ã‚ã‚‰ãªã„
console.log(updated[0].active); // true
```

### è§£èª¬ï¼š

- `map` è‡ªä½“ã¯**æ–°ã—ã„é…åˆ—ã‚’ä½œã‚‹**ã®ã§éç ´å£Š
- ã—ã‹ã—ã€ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å†…ã§ `user.active = true` ã¨ã™ã‚‹ã¨**å…ƒã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç ´å£Š**ã—ã¦ã—ã¾ã†
- `{ ...user, active: true }` ã§**æ–°ã—ã„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ**ã‚’ä½œã‚‹

### å›³è§£ï¼š

```
âŒ user.active = true
   users[0] â”€â”€â”€â”€â”€â”€â”€â†’ { id: 1, active: true }  â† åŒã˜ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å¤‰æ›´
   updated[0] â”€â”€â”€â”€â”€â†’ â†‘

âœ… { ...user, active: true }
   users[0] â”€â”€â”€â”€â”€â”€â”€â†’ { id: 1, active: false }  â† å…ƒã®ã¾ã¾
   updated[0] â”€â”€â”€â”€â”€â†’ { id: 1, active: true }   â† æ–°ã—ã„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
```

</details>

---

# ğŸ”¹ Step 4ï¼šãƒã‚¹ãƒˆæ§‹é€ ã®æ›´æ–°

## å•é¡Œ 4ï¼šãƒã‚¹ãƒˆã—ãŸé…åˆ—

```js
const state = {
  users: [
    { id: 1, name: "Taro", tags: ["a"] },
    { id: 2, name: "Jiro", tags: ["b"] },
  ],
};

// id === 1 ã® user ã® tags ã« "c" ã‚’è¿½åŠ ã—ãŸã„
// æœŸå¾…ã™ã‚‹çµæœï¼š
// nextState.users[0].tags â†’ ["a", "c"]
// state.users[0].tags     â†’ ["a"]ï¼ˆå…ƒã®ã¾ã¾ï¼‰
```

è³ªå•ï¼šå…ƒã® state ã‚’å¤‰æ›´ã›ãšã€ä¸Šè¨˜ã®æœŸå¾…ã™ã‚‹çµæœã«ãªã‚‹ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦ãã ã•ã„ã€‚

<details>
<summary>æ¨¡ç¯„è§£ç­”</summary>

```js
const state = {
  users: [
    { id: 1, name: "Taro", tags: ["a"] },
    { id: 2, name: "Jiro", tags: ["b"] },
  ],
};

const nextState = {
  ...state,
  users: state.users.map((user) =>
    user.id === 1 ? { ...user, tags: [...user.tags, "c"] } : user
  ),
};

console.log(nextState.users[0].tags); // ["a", "c"]
console.log(state.users[0].tags);     // ["a"] â† å…ƒã®ã¾ã¾
```

### è§£èª¬ï¼š

ãƒã‚¹ãƒˆæ§‹é€ ã®æ›´æ–°ã¯**å„éšå±¤ã§æ–°ã—ã„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ/é…åˆ—ã‚’ä½œã‚‹**å¿…è¦ãŒã‚ã‚‹ã€‚

```js
{
  ...state,                    // 1. state ã‚’ã‚³ãƒ”ãƒ¼
  users: state.users.map(...)  // 2. users ã‚’æ–°ã—ã„é…åˆ—ã«
    user.id === 1
      ? { ...user, tags: [...user.tags, "c"] }  // 3. å¯¾è±¡userã‚’æ–°ã—ã„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«
      : user                                     // 4. ä»–ã¯ãã®ã¾ã¾
}
```

### éšå±¤ã”ã¨ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼š

```
state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ nextStateï¼ˆæ–°è¦ï¼‰
  â””â”€ users â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’   â””â”€ usersï¼ˆæ–°è¦é…åˆ—ï¼‰
       â””â”€ [0] (Taro) â”€â”€â†’        â””â”€ [0]ï¼ˆæ–°è¦ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼‰
            â””â”€ tags â”€â”€â”€â†’             â””â”€ tagsï¼ˆæ–°è¦é…åˆ—ï¼‰
       â””â”€ [1] (Jiro) â”€â”€â†’        â””â”€ [1]ï¼ˆåŒã˜å‚ç…§ã§OKï¼‰
```

</details>

---

# ğŸ”¹ Step 5ï¼šmap ã¨ reduce ã®ä½¿ã„åˆ†ã‘

## å•é¡Œ 5ï¼šæ¡ä»¶ä»˜ãæ›´æ–°

```js
const cart = [
  { id: 1, count: 1 },
  { id: 2, count: 2 },
];

// id === 2 ã® count ã‚’ +1 ã—ãŸã„
// æœŸå¾…ã™ã‚‹çµæœï¼š
// updated â†’ [{ id: 1, count: 1 }, { id: 2, count: 3 }]
// cart    â†’ [{ id: 1, count: 1 }, { id: 2, count: 2 }]ï¼ˆå…ƒã®ã¾ã¾ï¼‰
```

è³ªå•ï¼š
1. å…ƒã® cart ã‚’å¤‰æ›´ã›ãšã€ä¸Šè¨˜ã®æœŸå¾…ã™ã‚‹çµæœã«ãªã‚‹ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦ãã ã•ã„ã€‚
2. ã“ã®å‡¦ç†ã¯ map ã¨ reduceã€ã©ã¡ã‚‰ã‚’ä½¿ã†ã¹ãã§ã™ã‹ï¼Ÿ

<details>
<summary>æ¨¡ç¯„è§£ç­”</summary>

```js
const cart = [
  { id: 1, count: 1 },
  { id: 2, count: 2 },
];

const updated = cart.map((item) =>
  item.id === 2 ? { ...item, count: item.count + 1 } : item
);

console.log(updated); // [{ id: 1, count: 1 }, { id: 2, count: 3 }]
console.log(cart);    // [{ id: 1, count: 1 }, { id: 2, count: 2 }] â† å…ƒã®ã¾ã¾
```

### è§£èª¬ï¼š

- `map` ã§å…¨è¦ç´ ã‚’èµ°æŸ»
- `id === 2` ãªã‚‰æ–°ã—ã„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã€ãã‚Œä»¥å¤–ã¯ãã®ã¾ã¾è¿”ã™
- **å…ƒã®é…åˆ—ã®é•·ã•ãŒå¤‰ã‚ã‚‰ãªã„æ›´æ–°ã¯ map ãŒæœ€é©**

### reduce ã§ã‚‚æ›¸ã‘ã‚‹ãŒï¼š

```js
const updated = cart.reduce((acc, item) => {
  if (item.id === 2) {
    acc.push({ ...item, count: item.count + 1 });
  } else {
    acc.push(item);
  }
  return acc;
}, []);
```

ã“ã®ã‚±ãƒ¼ã‚¹ã§ã¯ reduce ã‚ˆã‚Š **map ã®æ–¹ãŒã‚·ãƒ³ãƒ—ãƒ«**ã€‚
reduce ã¯ã€Œé…åˆ—ã®é•·ã•ãŒå¤‰ã‚ã‚‹ã€ã€Œé›†è¨ˆã™ã‚‹ã€å ´åˆã«ä½¿ã†ã€‚

> è©³ã—ãã¯ **12_js-async-map-reduce-drill.md** ã®ã€Œfilter + map vs reduceã€ã‚’å‚ç…§ã€‚

</details>

---

## ğŸ¯ ã“ã®ãƒ‰ãƒªãƒ«ã®ã¾ã¨ã‚

| ãƒ‘ã‚¿ãƒ¼ãƒ³ | ç ´å£Šçš„ï¼ˆâŒï¼‰ | éç ´å£Šçš„ï¼ˆâœ…ï¼‰ |
|----------|------------|--------------|
| é…åˆ—ã«è¿½åŠ  | `arr.push(item)` | `[...arr, item]` |
| ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæ›´æ–° | `obj.key = value` | `{ ...obj, key: value }` |
| é…åˆ—å†…ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæ›´æ–° | `arr[i].key = value` | `arr.map(x => ({ ...x, key }))` |
| ãƒã‚¹ãƒˆæ§‹é€  | ç›´æ¥ä»£å…¥ | å„éšå±¤ã§ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ |

### åˆ¤æ–­åŸºæº–ï¼š

- ã€Œå…ƒã®å€¤ãŒå¤‰ã‚ã‚‹ã‹ï¼Ÿã€â†’ å¤‰ã‚ã‚‹ãªã‚‰ç ´å£Šçš„
- ã€Œæ–°ã—ã„å‚ç…§ãŒä½œã‚‰ã‚Œã‚‹ã‹ï¼Ÿã€â†’ ä½œã‚‰ã‚Œãªã„ãªã‚‰ç ´å£Šçš„

---

ä»¥ä¸Šã€‚
